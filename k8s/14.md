# Kube Prometheus Stack 

## Components:
- **Prometheus Operator** — tool to deploy and configurate Prometheus inside k8s
- **Prometheus** — monitors metrics and saves them in database
- **Alert manager** — collects alerts and sends them to developers (messengers, email, etc.)
- **Node exporter** — looks on hardware metric in UNIX-like systems
- **Prometheus Adapter for Kubernetes Metrics APIs** — k8s API for metrics
- **kube-state-metrics** — generate k8s' objects' metrics from API
- **Grafana** — visualize collected metrics in Dashboards

## Chart installation

```sh
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install prometheus prometheus-community/kube-prometheus-stack
```

The `kubectl get po,sts,svc,pvc,cm` command allows us to see the state of all Pods, StatefulSets, Services, Persistent Volumes, and ConfigMaps
```sh
NAME                                                         READY   STATUS    RESTARTS        AGE
pod/alertmanager-prometheus-kube-prometheus-alertmanager-0   2/2     Running   1 (2m14s ago)   2m42s
pod/msc-time-py-0                                            1/1     Running   2 (4m57s ago)   10d
pod/msc-time-py-1                                            1/1     Running   2 (4m57s ago)   10d
pod/msc-time-py-2                                            1/1     Running   2 (4m57s ago)   10d
pod/prometheus-grafana-5d9f5d6499-pg22x                      3/3     Running   0               3m6s
pod/prometheus-kube-prometheus-operator-689dd6679c-ns7mm     1/1     Running   0               3m6s
pod/prometheus-kube-state-metrics-6cfd96f4c8-v9hwg           1/1     Running   0               3m6s
pod/prometheus-prometheus-kube-prometheus-prometheus-0       2/2     Running   0               2m42s
pod/prometheus-prometheus-node-exporter-pt2d7                1/1     Running   0               3m6s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-prometheus-kube-prometheus-alertmanager   1/1     2m43s
statefulset.apps/msc-time-py                                            3/3     10d
statefulset.apps/prometheus-prometheus-kube-prometheus-prometheus       1/1     2m42s

NAME                                              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE  
service/alertmanager-operated                     ClusterIP      None             <none>        9093/TCP,9094/TCP,9094/UDP   2m43s
service/kubernetes                                ClusterIP      10.96.0.1        <none>        443/TCP                      38d  
service/msc-time-py                               LoadBalancer   10.98.76.143     <pending>     80:31809/TCP                 10d  
service/prometheus-grafana                        ClusterIP      10.110.117.36    <none>        80/TCP                       3m6s 
service/prometheus-kube-prometheus-alertmanager   ClusterIP      10.102.213.107   <none>        9093/TCP                     3m6s 
service/prometheus-kube-prometheus-operator       ClusterIP      10.105.171.87    <none>        443/TCP                      3m6s 
service/prometheus-kube-prometheus-prometheus     ClusterIP      10.103.115.203   <none>        9090/TCP                     3m6s 
service/prometheus-kube-state-metrics             ClusterIP      10.101.95.169    <none>        8080/TCP                     3m6s 
service/prometheus-operated                       ClusterIP      None             <none>        9090/TCP                     2m42s
service/prometheus-prometheus-node-exporter       ClusterIP      10.102.254.55    <none>        9100/TCP                     3m6s

NAME                                                                     DATA   AGE
configmap/config-file                                                    1      10d
configmap/kube-root-ca.crt                                               1      38d
configmap/prometheus-grafana                                             1      3m6s
configmap/prometheus-grafana-config-dashboards                           1      3m6s
configmap/prometheus-kube-prometheus-alertmanager-overview               1      3m6s
configmap/prometheus-kube-prometheus-apiserver                           1      3m6s
configmap/prometheus-kube-prometheus-cluster-total                       1      3m6s
configmap/prometheus-kube-prometheus-controller-manager                  1      3m6s
configmap/prometheus-kube-prometheus-etcd                                1      3m6s
configmap/prometheus-kube-prometheus-grafana-datasource                  1      3m6s
configmap/prometheus-kube-prometheus-grafana-overview                    1      3m6s
configmap/prometheus-kube-prometheus-k8s-coredns                         1      3m6s
configmap/prometheus-kube-prometheus-k8s-resources-cluster               1      3m6s
configmap/prometheus-kube-prometheus-k8s-resources-namespace             1      3m6s
configmap/prometheus-kube-prometheus-k8s-resources-node                  1      3m6s
configmap/prometheus-kube-prometheus-k8s-resources-pod                   1      3m6s
configmap/prometheus-kube-prometheus-k8s-resources-workload              1      3m6s
configmap/prometheus-kube-prometheus-k8s-resources-workloads-namespace   1      3m6s
configmap/prometheus-kube-prometheus-kubelet                             1      3m6s
configmap/prometheus-kube-prometheus-namespace-by-pod                    1      3m6s
configmap/prometheus-kube-prometheus-namespace-by-workload               1      3m6s
configmap/prometheus-kube-prometheus-node-cluster-rsrc-use               1      3m6s
configmap/prometheus-kube-prometheus-node-rsrc-use                       1      3m6s
configmap/prometheus-kube-prometheus-nodes                               1      3m6s
configmap/prometheus-kube-prometheus-nodes-darwin                        1      3m6s
configmap/prometheus-kube-prometheus-persistentvolumesusage              1      3m6s
configmap/prometheus-kube-prometheus-pod-total                           1      3m6s
configmap/prometheus-kube-prometheus-prometheus                          1      3m6s
configmap/prometheus-kube-prometheus-proxy                               1      3m6s
configmap/prometheus-kube-prometheus-scheduler                           1      3m6s
configmap/prometheus-kube-prometheus-workload-total                      1      3m6s
configmap/prometheus-prometheus-kube-prometheus-prometheus-rulefiles-0   29     2m42s
```

## Check the Grafana
To enable the access to Grafana outside the k8s cluster use `minikube service prometheus-grafana`.
For me, default credentials were `admin` and `prom-operator` as password.

1. Using the dashboard `Kubernetes / Compute Resources / Namespace (Workloads)` and **type statefulset, workload msc-time-py** I can see the CPU and RAM usage of pods

![](./pics/lab_14/1_statefulset_cpu_usage.png)

2. On `Kubernetes / Compute Resources / Namespace (Pods)` dashboard view the CPU usage

![](./pics/lab_14/2_pods_cpu_usage.png)

As we can see, Prometheus pod takes much more than msc-time-py nods, and especially `msc-time-py-0` pod

3. Use `Kubernetes / Compute Resources / Node (Pods)` to check Memory usage by pods on Node

![](./pics/lab_14/3_memory.png)

4. Open `Kubernetes / Kublet` to see the statistics for Kubelet

![](./pics/lab_14/4_kubelet.png)

5. `Kubernetes / Networking / Namespace (Pods)` shows the traffic for every pod

![](./pics/lab_14/5_traffic.png)

So, Grafana and Prometheus take most of the bandwidth of the network

6. With the help of Web Alertmanager I found 5 alerts

![](./pics/lab_14/6_alerts.png)

## Init containers

Add the following under the `spec.template.spec` field inside `statefulset.yaml`:

```yaml
initContainers:
- name: init
  image: busybox:1.28
  command:
  - wget
  - "-O"
  - "/work-dir/index.html"
  - http://info.cern.ch
  volumeMounts:
  - name: booting
    mountPath: "/booting"
```

Also, define the volume in `spec.template.spec.containers.volumeMounts`:

```yaml
- name: booting
  mountPath: "/app/test"
```

... and register new volume inside the `spec.template.spec.volume` attribute:

```yaml
- name: booting
  emptyDir: {}
```

We need to have the same shared volume for `initContainer` and regular one to save the result

Now let us check if it works:

```sh
helm upgrade control .\chart-msc-time\ 
kubectl exec msc-time-py-2 -- cat /app/test/index.html
```

The result:
```html
Defaulted container "chart-msc-time" out of: chart-msc-time, init (init)
<html><head></head><body><header>
<title>http://info.cern.ch</title>
</header>

<h1>http://info.cern.ch - home of the first website</h1>
<p>From here you can:</p>
<ul>
<li><a href="http://info.cern.ch/hypertext/WWW/TheProject.html">Browse the first website</a></li>
<li><a href="http://line-mode.cern.ch/www/hypertext/WWW/TheProject.html">Browse the first website using the line-mode browser simulator</a></li>
<li><a href="http://home.web.cern.ch/topics/birth-web">Learn about the birth of the web</a></li>
<li><a href="http://home.web.cern.ch/about">Learn about CERN, the physics laboratory where the web was born</a></li>
</ul>
</body></html>
```
File from `initContainer` successfully saved into the application pod